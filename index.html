<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mining Empire — Enhanced</title>
<style>
/* --- CORE VARIABLES --- */
:root{
    --bg:#071027;
    --panel-dark:#0e1730;
    --panel-light:#152243;
    --muted:#aab4d6;
    --accent:#ffd36b; /* Gold */
    --accent2:#6ee7ff; /* Diamond/Cyan */
    --good:#6bff9b;
    --bad:#ff6b6b;
    --platinum:#e5e5e5;
    --cosmic:#9f6bff;
} 
*{box-sizing:border-box;font-family:Inter,system-ui,Arial} 
html,body{
    height:100%;
    margin:0;
    background:linear-gradient(180deg,#040e24 0%,#06111a 100%);
    color:#eef2ff;
    overflow:hidden; /* Prevent scroll during intro */
} 
body.loaded { overflow:auto; }

/* --- INTRO ANIMATION --- */
#intro {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: #050b14;
    z-index: 99999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity 0.8s ease-out, visibility 0.8s;
}
#intro.hidden {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
}
.intro-icon {
    width: 80px;
    height: 80px;
    margin-bottom: 20px;
}
.pick-anim {
    transform-origin: bottom right;
    animation: miningHit 0.6s ease-in-out infinite;
}
@keyframes miningHit {
    0% { transform: rotate(0deg); }
    50% { transform: rotate(-45deg); }
    100% { transform: rotate(0deg); }
}
.intro-text {
    font-size: 32px;
    font-weight: 900;
    color: var(--accent);
    text-shadow: 0 0 20px rgba(255, 211, 107, 0.4);
    opacity: 0;
    animation: fadeIn 0.5s ease-out 0.5s forwards;
}
@keyframes fadeIn { to { opacity: 1; } }

/* --- APP LAYOUT --- */
.app{
    max-width:1240px;
    margin:20px auto;
    padding:20px;
    border-radius:16px;
    background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(0,0,0,0.08));
    box-shadow:0 15px 50px rgba(0,0,0,0.7), inset 0 0 150px rgba(255,255,255,0.01);
    border:1px solid rgba(255,255,255,0.05);
} 
header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding-bottom:16px;
    border-bottom:1px solid rgba(255,255,255,0.08);
} 
h1{
    margin:0;
    font-size:24px;
    color:var(--accent);
    text-shadow:0 0 8px rgba(255,211,107,0.4);
} 
.top-right{display:flex; gap:12px; align-items:center; flex-wrap:wrap} 
.stat{
    background:var(--panel-dark);
    padding:10px 14px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.05);
    font-weight:700;
    color:var(--muted);
    min-width:110px;
    text-align:center;
} 
.layout{display:grid; grid-template-columns:1fr 420px; gap:20px; margin-top:20px;} 
.game{
    background:var(--panel-dark);
    padding:16px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.05);
} 
.hud{
    display:flex;
    gap:10px;
    align-items:center;
    margin-bottom:10px;
    padding-bottom:10px;
    border-bottom:1px dashed rgba(255,255,255,0.05);
} 
.ground{
    width:100%;
    height:520px;
    background:linear-gradient(180deg,#031323,#071428);
    border-radius:12px;
    position:relative;
    overflow:hidden;
    border:2px solid rgba(255,255,255,0.08);
    box-shadow:inset 0 0 10px rgba(0,0,0,0.5);
} 
.tile{
    position:absolute;
    width:56px;
    height:56px;
    background:#1f334a;
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    color:#88a0c7;
    cursor:pointer;
    user-select:none;
    border:1px solid rgba(255,255,255,0.05);
    transition:background 0.1s, transform 0.1s;
    box-shadow:inset 0 4px 6px rgba(0,0,0,0.2), 0 2px 3px rgba(0,0,0,0.4);
}
.tile:hover:not(.dug){ background:#2c405a; transform:translateY(-1px); }
.dug{
    background:linear-gradient(180deg,#172b38,#0d2432);
    color:#f8f9fb;
    box-shadow:inset 0 4px 6px rgba(0,0,0,0.3);
} 
.ore {
    width:36px; height:36px; border-radius:6px;
    display:flex; align-items:center; justify-content:center;
    font-weight:800; box-shadow:0 2px 4px rgba(0,0,0,0.5);
} 
.panel{
    background:var(--panel-light);
    padding:16px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.05);
    box-shadow:0 4px 15px rgba(0,0,0,0.3);
} 
.shop h3{margin:0 0 12px 0; color:var(--accent2);} 
.shop .item{
    display:flex; justify-content:space-between; align-items:center;
    padding:10px; border-radius:10px; margin-bottom:10px;
    background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent);
    border:1px solid rgba(255,255,255,0.02);
} 
.btn{
    background:linear-gradient(180deg,#2b3754,#1a243d);
    border-radius:8px; padding:10px 14px;
    border:1px solid rgba(255,255,255,0.08);
    cursor:pointer; color:#eef2ff; font-weight:700;
    text-shadow:0 1px 2px rgba(0,0,0,0.5);
    transition:background 0.1s;
} 
.btn:hover{ background:linear-gradient(180deg,#3b4a6b,#2a3457); }
.btn:active{ transform:translateY(1px); } 
.btn[disabled]{ opacity:.6; filter:grayscale(1); cursor:not-allowed; background:#2b3754; } 
/* Special Descend Button Style */
.btn-primary { background:linear-gradient(180deg, #1fa2ff, #125488); border-color:#6ee7ff; }
.btn-primary:hover { background:linear-gradient(180deg, #3bb0ff, #1a6ca8); }

.small{font-size:13px;color:var(--muted)} 
.upgrade-list{max-height:300px;overflow:auto;padding-right:8px} 
.center{display:flex;align-items:center;justify-content:center} 
footer{margin-top:16px;color:var(--muted);font-size:13px} 
.right-col{display:flex;flex-direction:column;gap:16px} 
.progress{height:12px;background:rgba(255,255,255,0.06);border-radius:6px;overflow:hidden;box-shadow:inset 0 1px 3px rgba(0,0,0,0.5);} 
.progress > i{
    display:block; height:100%;
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    width:0%; transition:width 0.3s;
} 
.muted{color:var(--muted)} 
.controls{display:flex;gap:10px} 
input[type=file]{display:none} 
.spark{
    position:absolute; pointer-events:none; mix-blend-mode:screen;
    border-radius:50%; opacity:.9; filter:blur(1px);
} 
.row{display:flex;gap:10px;align-items:center} 
.divider{height:1px;background:rgba(255,255,255,.1);margin:10px 0} 
.ore-list-item{
    background:rgba(0,0,0,0.1); border-radius:6px;
    padding:6px; margin-bottom:4px;
    border-left:4px solid rgba(255,255,255,0.1);
}
@media (max-width:1080px){.layout{grid-template-columns:1fr}.right-col{order:2}}
</style>
</head> 
<body>

<div id="intro">
    <div class="intro-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="#ffd36b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2l4 4L7 17H3v-4L14 2z" class="pick-anim"></path>
            <path d="M3 21h18" style="stroke:#6ee7ff; stroke-width:3"></path>
        </svg>
    </div>
    <div class="intro-text">Mining Empire</div>
</div>

<div class="app"> 
<header> 
    <h1>Mining Empire ⛏️</h1> 
    <div class="top-right"> 
        <div class="stat">Money: $<span id="money">0</span></div> 
        <div class="stat">Gems: <span id="gems">0</span></div> 
        <div class="stat">Prestige: <span id="prestige">0</span></div> 
        <div class="stat">x<span id="mult">1.0</span> income</div> 
    </div> 
</header> 

<div class="layout"> 
    <div class="game"> 
        <div class="hud"> 
            <button class="btn btn-primary" id="descendBtn" title="Descend to next layer (P)">Descend ⬇</button>
            <div style="width:1px; height:24px; background:rgba(255,255,255,0.1); margin:0 10px;"></div>
            
            <div class="small muted" style="flex:1">
                Shortcuts: <b>U</b>pgrade, <b>M</b>iner, <b>S</b>ell, <b>P</b> Descend.
            </div>
            
            <div class="controls"> 
                <button class="btn" id="exportBtn" title="Download Save">Export</button> 
                <label class="btn" for="importFile" title="Upload Save">Import</label> 
                <input id="importFile" type="file" accept="application/json"> 
            </div> 
        </div> 

        <div class="ground" id="ground"></div> 
        
        <div style="margin-top:16px;display:flex;gap:16px;align-items:center;flex-wrap:wrap"> 
            <div style="width:240px"> 
                <div class="small muted">Shovel XP</div> 
                <div class="progress"><i id="shovelPowerBar"></i></div> 
            </div> 
            <div class="small muted">Lvl: <strong id="shovelLvl">1</strong></div> 
            <div class="small muted">Miners: <span id="minersCount">0</span></div> 
            <div class="small muted">Depth: <span id="depth">0</span></div> 
            <div class="small muted">Dug: <span id="layerDug">0</span>/<span id="layerTotal">0</span></div> 
        </div> 
    </div> 

    <div class="right-col"> 
        <div class="panel shop"> 
            <h3>Shop & Upgrades</h3> 
            <div class="row"> 
                <button class="btn" id="upgradeShovel">Upgrade Shovel ($<span id="shovelCost">0</span>)</button> 
                <button class="btn" id="buyMiner">Buy Miner ($<span id="minerCost">0</span>)</button> 
            </div> 
            <div class="small muted" id="shopHint" style="margin-top:8px"></div> 
            <div class="divider"></div> 
            <div class="upgrade-list" id="shopList"></div> 
        </div> 

        <div class="panel"> 
            <h3>Inventory</h3> 
            <div id="inventory" style="min-height:120px"></div> 
            <div style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap"> 
                <button class="btn" id="sellAll" title="S">Sell All</button> 
                <button class="btn" id="sellHigh">Sell Highest</button> 
                <button class="btn" id="toggleCraft">Crafting ▼</button> 
            </div> 
            <div id="craftPanel" style="display:none;margin-top:10px"> 
                <div class="small muted" style="margin-bottom:8px">x<span id="gemMult">1.0</span> gem output.</div> 
                <div id="recipes"></div> 
            </div> 
        </div> 

        <div class="panel"> 
            <h3>Prestige & Settings</h3> 
            <div class="small muted" id="prestigeText"></div> 
            <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap"> 
                <button class="btn" id="prestigeBtn">Prestige</button> 
                <button class="btn" id="newLayerBtn" title="N">New Layer</button> 
                <button class="btn" id="resetBtn">Reset Game</button> 
            </div> 
        </div> 
    </div> 
</div> 
<footer class="center muted">
    Mining Empire v4.1 - Autosave Enabled.
</footer> 
</div> 

<script> 
// --- INTRO HANDLER ---
window.addEventListener('load', () => {
    // Wait a moment for animation to play then hide
    setTimeout(() => {
        const intro = document.getElementById('intro');
        intro.classList.add('hidden');
        document.body.classList.add('loaded');
        setTimeout(() => intro.remove(), 1000); // Cleanup DOM
    }, 2200);
});

// --- CONFIG --- 
const cfg = { 
    cols: 12, 
    rows: 8, 
    tileSize: 56, 
    baseDigTime: 900, 
    oreTable: [ 
        {id:'Stone', value:1, chance:0.58, color:'#7b8fa6', symbol:'◦'}, 
        {id:'Coal', value:6, chance:0.20, color:'#36454f', symbol:'●'}, 
        {id:'Iron', value:18, chance:0.12, color:'#bfbfc1', symbol:'⛒'}, 
        {id:'Gold', value:60, chance:0.06, color:'#ffd36b', symbol:'◎'}, 
        {id:'Diamond', value:250, chance:0.03, color:'#6ee7ff', symbol:'◆'}, 
        {id:'Platinum', value:800, chance:0.008, color:'var(--platinum)', symbol:'⛭'}, 
        {id:'Mythic', value:1200, chance:0.003, color:'#dca7ff', symbol:'✶'},
        {id:'Cosmic', value:5000, chance:0.001, color:'var(--cosmic)', symbol:'★'} 
    ], 
    version: 'v4_autoupdate' 
}; 

const recipes = [ 
    {id:'r_stone', label:'50 Stone → 1 Gem', inputs:{Stone:50}, gems:1}, 
    {id:'r_iron', label:'20 Iron → 1 Gem', inputs:{Iron:20}, gems:1}, 
    {id:'r_gold', label:'10 Gold → 1 Gem', inputs:{Gold:10}, gems:1}, 
    {id:'r_dia', label:'3 Diamond → 2 Gems', inputs:{Diamond:3}, gems:2}, 
    {id:'r_plat', label:'2 Platinum → 3 Gems', inputs:{Platinum:2}, gems:3}, 
    {id:'r_mythic', label:'1 Mythic → 5 Gems', inputs:{Mythic:1}, gems:5},
    {id:'r_cosmic', label:'1 Cosmic → 20 Gems', inputs:{Cosmic:1}, gems:20} 
]; 

// --- STATE --- 
let state = { 
    money: 0, 
    gems: 0, 
    shovelLvl: 1, 
    shovelXP: 0, 
    shovelXPForNext: 120, 
    miners: 0, 
    prestige: 0, 
    prestigeMultiplier: 1, 
    gemMultiplier: 1, 
    autoSellEnabled: false, 
    autoDescendEnabled: false, // NEW
    tiles: [], 
    depth: 0, 
    layerDug: 0, 
    totalDug: 0, 
    inventory: {}, 
    autosaveKey: 'mining_empire_final_v4' 
}; 

// --- DOM ELEMENTS --- 
const groundEl = document.getElementById('ground'); 
const moneyEl = document.getElementById('money'); 
const gemsEl = document.getElementById('gems'); 
const shovelLvlEl = document.getElementById('shovelLvl'); 
const shopListEl = document.getElementById('shopList'); 
const inventoryEl = document.getElementById('inventory'); 
const sellAllBtn = document.getElementById('sellAll'); 
const sellHighBtn = document.getElementById('sellHigh'); 
const buyMinerBtn = document.getElementById('buyMiner'); 
const upgradeShovelBtn = document.getElementById('upgradeShovel'); 
const minersCountEl = document.getElementById('minersCount'); 
const depthEl = document.getElementById('depth'); 
const shovelPowerBar = document.getElementById('shovelPowerBar'); 
const prestigeEl = document.getElementById('prestige'); 
const prestigeBtn = document.getElementById('prestigeBtn'); 
const descendBtn = document.getElementById('descendBtn'); 
const exportBtn = document.getElementById('exportBtn'); 
const importFile = document.getElementById('importFile'); 
const toggleCraftBtn = document.getElementById('toggleCraft'); 
const recipesEl = document.getElementById('recipes'); 
const multEl = document.getElementById('mult'); 
const layerDugEl = document.getElementById('layerDug'); 
const layerTotalEl = document.getElementById('layerTotal'); 
const shovelCostEl = document.getElementById('shovelCost'); 
const minerCostEl = document.getElementById('minerCost'); 
const shopHintEl = document.getElementById('shopHint'); 
const newLayerBtn = document.getElementById('newLayerBtn'); 
const resetBtn = document.getElementById('resetBtn'); 
const prestigeText = document.getElementById('prestigeText'); 
const gemMultEl = document.getElementById('gemMult'); 

// --- UTILITIES --- 
function formatNum(n){ return Math.round(n).toLocaleString(); } 
function flash(msg, color){ 
    const el = document.createElement('div'); 
    el.textContent = msg; 
    el.style.cssText = `position:fixed; left:50%; top:20px; transform:translateX(-50%); padding:10px 14px; background:rgba(10,16,30,0.95); border:1px solid rgba(255,255,255,0.1); border-radius:10px; z-index:9999; color:${color||'var(--muted)'}`;
    document.body.appendChild(el); 
    setTimeout(()=>el.remove(),1200); 
} 
function tileCount(){ return cfg.cols * cfg.rows; } 

// --- GAME LOGIC --- 
function makeLayer(){ 
    groundEl.innerHTML=''; 
    state.tiles = []; 
    state.layerDug = 0; 
    const cols = cfg.cols, rows = cfg.rows; 
    const s = cfg.tileSize; 
    groundEl.style.height = (rows*s)+'px'; 
    groundEl.style.width = (cols*s)+'px'; 
    layerTotalEl.textContent = tileCount(); 
    for(let r=0;r<rows;r++){ 
        for(let c=0;c<cols;c++){ 
            const idx = r*cols + c; 
            const el = document.createElement('div'); 
            el.className='tile'; 
            el.style.left = (c*s)+'px'; 
            el.style.top=(r*s)+'px'; 
            el.style.width=s+'px'; 
            el.style.height=s+'px'; 
            el.dataset.index = idx; 
            el.addEventListener('click', ()=>digTile(idx, el)); 
            groundEl.appendChild(el); 
            state.tiles.push({dug:false, ore:null, depth:state.depth}); 
        } 
    } 
} 

function pickOre(depth){ 
    // Logic: deeper = higher chance for good stuff
    const adj = cfg.oreTable.map(o=>({ 
        ...o, 
        adj: o.chance * (1 + depth*0.03 + state.shovelLvl*0.005) 
    })); 
    const total = adj.reduce((s,i)=>s+i.adj,0); 
    let r = Math.random()*total; 
    for(const a of adj){ 
        if(r < a.adj) return a; 
        r -= a.adj; 
    } 
    return adj[0]; 
} 

// NERFED CRATE LOGIC
function pickCrateOre(){
    // Always treats depth as 0 (Surface) so chances are low
    // Plus manually reduces chance of top tier items
    const adj = cfg.oreTable.map(o => {
        let c = o.chance; 
        if(o.id === 'Mythic' || o.id === 'Cosmic') c = c * 0.1; // 10x rarer in crates
        return { ...o, adj: c };
    });
    const total = adj.reduce((s,i)=>s+i.adj,0); 
    let r = Math.random()*total; 
    for(const a of adj){ 
        if(r < a.adj) return a; 
        r -= a.adj; 
    } 
    return adj[0];
}

function renderOreSVG(ore){ 
    const w = 36, h = 36; 
    return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
    <rect rx="6" width="${w}" height="${h}" fill="${ore.color}" style="filter:drop-shadow(1px 1px 2px rgba(0,0,0,0.6));"/>
    <text x="50%" y="56%" font-size="18" font-weight="800" text-anchor="middle" fill="#062022">${ore.symbol}</text>
    </svg>`; 
} 

function makeSpark(x,y){ 
    const d = document.createElement('div'); 
    const size = 6 + Math.random()*8; 
    d.className='spark'; 
    d.style.width=d.style.height=size+'px'; 
    d.style.background='radial-gradient(circle, var(--accent), rgba(255,211,107,.1))'; 
    d.style.left=(x-size/2)+'px'; 
    d.style.top=(y-size/2)+'px'; 
    groundEl.appendChild(d); 
    const dx = (Math.random()-0.5)*50; 
    const dy = -15 - Math.random()*30; 
    const dur = 450+Math.random()*350; 
    const start = performance.now(); 
    function anim(t){ 
        const p = Math.min(1,(t-start)/dur); 
        d.style.transform = `translate(${dx*p}px, ${dy*p}px)`; 
        d.style.opacity = String(0.9*(1-p)); 
        if(p<1) requestAnimationFrame(anim); else d.remove(); 
    } 
    requestAnimationFrame(anim); 
} 

function digTile(i, el){ 
    const t = state.tiles[i]; 
    if(t.dug) return; 
    el.classList.add('dug'); 
    el.style.pointerEvents='none'; 
    el.innerHTML = '<div class="small muted">...</div>'; 
    const base = cfg.baseDigTime; 
    const time = Math.max(90, base / (1 + state.shovelLvl*0.28)); 
    const rect = groundEl.getBoundingClientRect(); 
    setTimeout(()=>{ 
        const ore = pickOre(state.depth); 
        const tileRect = el.getBoundingClientRect(); 
        t.dug = true; t.ore = ore; 
        el.innerHTML = `<div class=ore style='background:${ore.color}'>${renderOreSVG(ore)}</div>`; 
        state.inventory[ore.id] = (state.inventory[ore.id]||0) + 1; 
        state.layerDug++; state.totalDug++; 
        state.shovelXP += Math.round(8 + ore.value*0.45); 
        for(let s=0;s<3;s++) makeSpark(tileRect.left-rect.left+28, tileRect.top-rect.top+28); 
        checkShovelLevel(); 
        updateUI(); 
        save(); 
    }, time); 
} 

function checkShovelLevel(){ 
    while(state.shovelXP >= state.shovelXPForNext){ 
        state.shovelXP -= state.shovelXPForNext; 
        state.shovelLvl++; 
        state.shovelXPForNext = Math.round(state.shovelXPForNext * 1.75 + 100); 
        const reward = Math.max(1, Math.floor(state.shovelLvl / 5)); 
        state.gems += reward;
        flash(`Shovel Lvl ${state.shovelLvl}! +${reward} Gems`, 'var(--good)'); 
    } 
} 

function shovelUpgradeCost(){ return Math.round(300 * Math.pow(1.6, Math.max(0, state.shovelLvl-1))); } 
function minerCost(){ return Math.round(200 * Math.pow(1.45, state.miners)); } 

function updateUI(){ 
    state.prestigeMultiplier = 1 + (state.prestige||0) * 0.10; 
    state.gemMultiplier = 1 + (state.prestige||0) * 0.05; 
    
    moneyEl.textContent = formatNum(state.money); 
    gemsEl.textContent = formatNum(state.gems); 
    shovelLvlEl.textContent = state.shovelLvl; 
    minersCountEl.textContent = state.miners; 
    depthEl.textContent = state.depth; 
    layerDugEl.textContent = state.layerDug; 
    prestigeEl.textContent = state.prestige; 
    multEl.textContent = state.prestigeMultiplier.toFixed(2); 
    gemMultEl.textContent = state.gemMultiplier.toFixed(2);
    
    renderShop(); 
    renderInventory(); 

    const pct = Math.min(100, Math.round((state.shovelXP / state.shovelXPForNext) * 100)); 
    shovelPowerBar.style.width = pct+'%'; 
    
    prestigeBtn.disabled = !canPrestige(); 
    const reqText = `Req: Depth 3+ & Total Dug 120+ or $5,000.`; 
    prestigeText.innerHTML = `Prestige: +10% income, +5% gems per level. ${reqText}`; 
} 

function renderShop(){ 
    const sCost = shovelUpgradeCost(); 
    const mCost = minerCost(); 
    shovelCostEl.textContent = formatNum(sCost); 
    minerCostEl.textContent = formatNum(mCost); 
    upgradeShovelBtn.disabled = state.money < sCost; 
    buyMinerBtn.disabled = state.money < mCost; 
    
    let status = [];
    if(state.autoSellEnabled) status.push("Auto-Sell ON");
    if(state.autoDescendEnabled) status.push("Auto-Descend ON");
    shopHintEl.textContent = status.length ? status.join(" | ") : "Buy upgrades to automate.";

    shopListEl.innerHTML = ''; 
    
    // 1. Nerfed Crate
    const crateCost = Math.round(120 * state.prestigeMultiplier * 1.5);
    const crateDiv = document.createElement('div'); 
    crateDiv.className='item'; 
    crateDiv.innerHTML = `<div style="display:flex;gap:4px;flex-direction:column"><div><strong>Ore Crate (10)</strong></div><div class=small>Contains basic surface ores.</div></div><div style="display:flex;flex-direction:column;gap:6px"><div>$${formatNum(crateCost)}</div><button class='btn' data-buy='crate1' ${state.money<crateCost?'disabled':''}>Buy</button></div>`; 
    shopListEl.appendChild(crateDiv); 
    shopListEl.querySelector("[data-buy='crate1']").addEventListener('click', ()=>{ 
        if(state.money < crateCost) return; 
        state.money -= crateCost; 
        for(let i=0;i<10;i++){ 
            const ore=pickCrateOre(); // Uses nerfed logic
            state.inventory[ore.id]=(state.inventory[ore.id]||0)+1; 
        } 
        updateUI(); save(); flash('Crate opened (Low luck)', 'var(--muted)'); 
    });

    // 2. Auto-Sell
    if(!state.autoSellEnabled){
        renderUpgradeItem('Auto-Sell', 'Auto sells highest value ore.', {type:'gems', val:10}, 'autosell');
    }

    // 3. Auto-Descend (NEW)
    if(!state.autoDescendEnabled){
        renderUpgradeItem('Auto-Descend', 'Descends when layer is clear.', {type:'gems', val:25}, 'autodescend');
    }
} 

function renderUpgradeItem(name, desc, costObj, id){
    const div = document.createElement('div');
    div.className='item';
    const costStr = costObj.type==='money' ? `$${formatNum(costObj.val)}` : `${costObj.val} Gems`;
    const canAfford = costObj.type==='money' ? state.money>=costObj.val : state.gems>=costObj.val;
    div.innerHTML = `<div style="display:flex;gap:4px;flex-direction:column"><div><strong>${name}</strong></div><div class=small>${desc}</div></div><div style="display:flex;flex-direction:column;gap:6px"><div>${costStr}</div><button class='btn' data-upg='${id}' ${canAfford?'':'disabled'}>Buy</button></div>`;
    shopListEl.appendChild(div);
    div.querySelector('button').addEventListener('click', ()=>{
        if(!canAfford) return;
        if(costObj.type==='money') state.money-=costObj.val; else state.gems-=costObj.val;
        
        if(id==='autosell') state.autoSellEnabled=true;
        if(id==='autodescend') state.autoDescendEnabled=true;
        
        updateUI(); save(); flash(name+' Enabled!', 'var(--good)');
    });
}

function renderInventory(){ 
    inventoryEl.innerHTML=''; 
    const keys = Object.keys(state.inventory).sort((a,b)=>cfg.oreTable.find(o=>o.id===a).value - cfg.oreTable.find(o=>o.id===b).value); 
    if(keys.length===0) inventoryEl.innerHTML = '<div class="small muted">Inventory empty.</div>'; 
    
    for(const k of keys){ 
        const val=state.inventory[k]; 
        const ore = cfg.oreTable.find(o=>o.id===k); 
        const sellValue = Math.round(ore.value * (1 + state.depth * 0.05) * state.prestigeMultiplier); 
        const row=document.createElement('div'); 
        row.className='ore-list-item'; row.style.display='flex'; row.style.justifyContent='space-between'; 
        row.innerHTML = `<div><strong>${k}</strong> <span class=small>$${formatNum(sellValue)}</span></div><div>${val}</div>`; 
        inventoryEl.appendChild(row); 
    } 
    renderRecipes(); 
} 

// --- ACTIONS ---
upgradeShovelBtn.addEventListener('click', ()=>{ 
    const cost = shovelUpgradeCost(); 
    if(state.money < cost) return; 
    state.money -= cost; state.shovelLvl++; 
    state.shovelXPForNext = Math.round(state.shovelXPForNext * 1.75 + 100); 
    updateUI(); save(); 
}); 
buyMinerBtn.addEventListener('click', ()=>{ 
    const cost = minerCost(); 
    if(state.money < cost) return; 
    state.money -= cost; state.miners++; 
    updateUI(); save(); 
}); 
sellAllBtn.addEventListener('click', ()=>{ 
    let total=0; 
    for(const k in state.inventory){ 
        const ore = cfg.oreTable.find(o=>o.id===k);
        const val = Math.round(ore.value * (1 + state.depth * 0.05) * state.prestigeMultiplier);
        total += val * state.inventory[k]; 
    } 
    state.money += total; state.inventory = {}; 
    flash(`Sold all for $${formatNum(total)}`); 
    updateUI(); save(); 
}); 
sellHighBtn.addEventListener('click', ()=>{
    let best=null, bestVal=0;
    for(const k in state.inventory){
         const ore = cfg.oreTable.find(o=>o.id===k);
         const val = Math.round(ore.value * (1 + state.depth * 0.05) * state.prestigeMultiplier);
         if(val>bestVal && state.inventory[k]>0){ bestVal=val; best=k; }
    }
    if(best){
        state.money+=bestVal; state.inventory[best]--;
        if(state.inventory[best]<=0) delete state.inventory[best];
        updateUI(); save();
    }
});

function craft(rc, times){ 
    let can = Infinity;
    for(const k in rc.inputs) can = Math.min(can, Math.floor((state.inventory[k]||0)/rc.inputs[k]));
    if(times > can) times = can;
    if(times<=0) return;

    const gemsToGain = Math.round(rc.gems * times * state.gemMultiplier);
    for(const k in rc.inputs){ 
        state.inventory[k] -= rc.inputs[k]*times; 
        if(state.inventory[k]<=0) delete state.inventory[k]; 
    } 
    state.gems += gemsToGain; 
    flash(`Crafted ${gemsToGain} Gems`, 'var(--good)'); 
    updateUI(); save(); 
} 

function renderRecipes(){ 
    recipesEl.innerHTML = ''; 
    recipes.forEach(rc=>{ 
        let can = Infinity;
        for(const k in rc.inputs) can = Math.min(can, Math.floor((state.inventory[k]||0)/rc.inputs[k]));
        
        const gemsPer = Math.round(rc.gems * state.gemMultiplier);
        const row = document.createElement('div'); row.className='row'; row.style.justifyContent='space-between'; row.style.margin='8px 0';
        row.innerHTML = `<div><strong class="small">${rc.id.replace('r_','').toUpperCase()}</strong> <span class="small muted">(${can})</span></div>
        <div><button class="btn small" id="c1_${rc.id}" ${can<1?'disabled':''}>+${gemsPer}</button>
        <button class="btn small" id="cm_${rc.id}" ${can<1?'disabled':''}>Max</button></div>`; 
        recipesEl.appendChild(row);
        document.getElementById(`c1_${rc.id}`).onclick = ()=>craft(rc,1);
        document.getElementById(`cm_${rc.id}`).onclick = ()=>craft(rc,9999);
    }); 
} 
document.getElementById('toggleCraft').onclick = () => {
    const p = document.getElementById('craftPanel');
    p.style.display = p.style.display==='none' ? 'block' : 'none';
};

// --- MINERS & AUTOMATION --- 
setInterval(()=>{ 
    // Miner Logic
    if(state.miners>0){ 
        const free = state.tiles.map((t,i)=> t.dug ? null : i).filter(x=>x!==null); 
        for(let m=0;m<state.miners && free.length;m++){ 
            const pick = free[Math.floor(Math.random()*free.length)];
            const el = groundEl.querySelector(`[data-index='${pick}']`); 
            if(el) digTile(pick, el); 
        } 
    }
    
    // Auto-Sell Logic (Every tick check)
    if(state.autoSellEnabled){
        let best=null, bestVal=0;
        for(const k in state.inventory){
            if(state.inventory[k]>1){ // Keep 1
                const ore = cfg.oreTable.find(o=>o.id===k);
                if(ore.value > bestVal){ bestVal=ore.value; best=k; }
            }
        }
        if(best) sellHighBtn.click();
    }
    
    // Auto-Descend Logic
    if(state.autoDescendEnabled && state.layerDug === tileCount()){
        shiftLayer();
    }
}, 1000); 

// --- LAYERS ---
descendBtn.addEventListener('click', shiftLayer); 
newLayerBtn.addEventListener('click', ()=>{ makeLayer(); updateUI(); save(); }); 

function shiftLayer(){ 
    state.depth++; makeLayer(); updateUI(); save(); 
    flash(`Descended to Depth ${state.depth}`); 
} 
function canPrestige(){ return (state.depth >= 3 && state.totalDug >= 120) || state.money >= 5000; } 
prestigeBtn.onclick = ()=>{ 
    if(!canPrestige()) return; 
    if(!confirm('Prestige? Resets progress for bonuses.')) return; 
    state.prestige++; 
    state.money=0; state.gems=0; state.shovelLvl=1; state.shovelXP=0; state.miners=0; 
    state.depth=0; state.layerDug=0; state.inventory={}; 
    state.autoSellEnabled=false; state.autoDescendEnabled=false; // Reset upgrades
    makeLayer(); updateUI(); save(); 
}; 

// --- SAVE SYSTEM --- 
function save(){ localStorage.setItem(state.autosaveKey, JSON.stringify(state)); } 
function load(){ 
    try {
        const s = JSON.parse(localStorage.getItem(state.autosaveKey)); 
        if(s) {
            state = Object.assign(state, s);
            // Ensure compatibility if new fields are missing
            if(typeof state.autoDescendEnabled === 'undefined') state.autoDescendEnabled = false;
        }
    } catch(e){} 
} 

// --- EXPORT/IMPORT ---
exportBtn.onclick = () => {
    const b = new Blob([JSON.stringify(state)],{type:'application/json'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='mining_save.json';
    a.click();
}
importFile.onchange = (e) => {
    const f=e.target.files[0]; if(!f)return;
    const r=new FileReader();
    r.onload=(ev)=>{ try{ state=Object.assign(state,JSON.parse(ev.target.result)); makeLayer(); updateUI(); save(); }catch(err){alert('Bad File');} };
    r.readAsText(f);
}
resetBtn.onclick = () => { if(confirm("Hard Reset?")) { localStorage.removeItem(state.autosaveKey); location.reload(); } }

// --- INIT --- 
load(); 
makeLayer(); 
updateUI(); 

// Keybinds
document.addEventListener('keydown', e => {
    if(e.key.toLowerCase()==='p') descendBtn.click();
    if(e.key.toLowerCase()==='u') upgradeShovelBtn.click();
    if(e.key.toLowerCase()==='m') buyMinerBtn.click();
    if(e.key.toLowerCase()==='s') sellAllBtn.click();
});
</script> 
</body>
</html>
