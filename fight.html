<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chaos Era</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #020617; font-family: 'Segoe UI', sans-serif; user-select: none; touch-action: none; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .interactive { pointer-events: auto; }
        
        #block-overlay {
            position: absolute; inset: 0; border: 12px solid rgba(59, 130, 246, 0.4);
            pointer-events: none; display: none; z-index: 40; box-shadow: inset 0 0 100px rgba(0,0,0,0.5);
        }

        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.hidden { opacity: 0; visibility: hidden; pointer-events: none; display: flex !important; }

        .loading-text { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="block-overlay"></div>

    <!-- Main Menu -->
    <div id="start-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-950 z-[100] px-6">
        <h1 class="text-6xl md:text-9xl font-black text-red-600 mb-2 uppercase italic tracking-tighter text-center drop-shadow-[0_0_20px_rgba(220,38,38,0.5)]">CHAOS ERA</h1>
        <p class="text-slate-400 mb-8 font-medium italic text-center text-sm md:text-base">AI Nerfed ‚Ä¢ Player Advantage ‚Ä¢ Berserker Tank Mode</p>
        
        <div class="flex flex-wrap justify-center gap-3 my-4 interactive">
            <button onclick="selectClass('infantry')" id="btn-infantry" class="class-btn border-2 border-slate-700 bg-slate-800/40 p-4 rounded-xl w-28 md:w-32 text-center transition-all hover:border-slate-400">
                <div class="text-2xl mb-1">üõ°Ô∏è</div><div class="font-bold text-[9px] uppercase">Infantry</div>
            </button>
            <button onclick="selectClass('knight')" id="btn-knight" class="class-btn border-2 border-slate-700 bg-slate-800/40 p-4 rounded-xl w-28 md:w-32 text-center transition-all hover:border-slate-400">
                <div class="text-2xl mb-1">‚öîÔ∏è</div><div class="font-bold text-[9px] uppercase">Knight</div>
            </button>
            <button onclick="selectClass('crusader')" id="btn-crusader" class="class-btn border-2 border-slate-700 bg-slate-800/40 p-4 rounded-xl w-28 md:w-32 text-center transition-all hover:border-slate-400">
                <div class="text-2xl mb-1">‚úùÔ∏è</div><div class="font-bold text-[9px] uppercase">Crusader</div>
            </button>
            <button onclick="selectClass('berserker')" id="btn-berserker" class="class-btn border-2 border-red-600 scale-110 bg-red-900/20 p-4 rounded-xl w-28 md:w-32 text-center transition-all">
                <div class="text-2xl mb-1">ü™ì</div><div class="font-bold text-[9px] uppercase text-red-400">Berserker</div>
            </button>
            <button onclick="selectClass('archer')" id="btn-archer" class="class-btn border-2 border-slate-700 bg-slate-800/40 p-4 rounded-xl w-28 md:w-32 text-center transition-all hover:border-slate-400">
                <div class="text-2xl mb-1">üèπ</div><div class="font-bold text-[9px] uppercase">Archer</div>
            </button>
        </div>

        <div class="flex gap-4 mt-4 interactive">
            <button onclick="startGame()" id="start-button" class="bg-red-700 hover:bg-red-600 text-white font-black py-4 px-12 md:px-20 rounded-2xl text-xl shadow-2xl uppercase tracking-tighter italic transition-all active:scale-95">
                START BATTLE
            </button>
            <button onclick="toggleControlsModal()" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-4 px-8 rounded-2xl text-sm uppercase tracking-widest border border-slate-600">
                Controls
            </button>
        </div>
        
        <div id="loading-indicator" class="hidden mt-6 text-red-500 font-bold uppercase tracking-widest loading-text text-xs">Assembling Legions...</div>
    </div>

    <!-- Controls Modal -->
    <div id="controls-modal" class="modal hidden fixed inset-0 z-[110] bg-black/95 flex items-center justify-center p-6">
        <div class="bg-slate-900 border-2 border-red-900 p-8 rounded-3xl max-w-md w-full shadow-2xl">
            <h2 class="text-3xl font-black text-red-600 mb-6 uppercase italic text-center">BATTLE CONTROLS</h2>
            <div class="space-y-4 text-slate-300">
                <div class="flex justify-between border-b border-slate-800 pb-2">
                    <span class="font-bold text-red-400 uppercase text-xs">Movement</span>
                    <span class="text-xs">W, A, S, D</span>
                </div>
                <div class="flex justify-between border-b border-slate-800 pb-2">
                    <span class="font-bold text-red-400 uppercase text-xs">Attack</span>
                    <span class="text-xs">Arrows / Space / Mouse Click</span>
                </div>
                <div class="flex justify-between border-b border-slate-800 pb-2">
                    <span class="font-bold text-red-400 uppercase text-xs">Infantry Block</span>
                    <span class="text-xs">Hold T</span>
                </div>
                <div class="bg-red-950/20 p-3 rounded-lg border border-red-900/50 mt-4">
                    <p class="text-[10px] text-red-200 uppercase leading-tight">Bot stats have been nerfed. They are slower and deal much less damage than you!</p>
                </div>
            </div>
            <button onclick="toggleControlsModal()" class="mt-8 w-full bg-red-800 py-3 rounded-xl font-black text-white uppercase tracking-widest hover:bg-red-700 transition-colors">
                BACK TO MENU
            </button>
        </div>
    </div>

    <!-- UI Overlay -->
    <div id="ui-layer">
        <div class="absolute top-8 left-8 flex flex-col gap-3">
            <div class="w-56 md:w-96 h-6 bg-slate-900/80 rounded-full border-2 border-white/10 overflow-hidden">
                <div id="hp-bar" class="h-full bg-gradient-to-r from-red-700 to-orange-500 transition-all duration-300" style="width: 100%"></div>
            </div>
            <div id="score" class="text-4xl font-black text-white italic tracking-tighter drop-shadow-2xl">KILLS: 0</div>
        </div>
    </div>

    <!-- Death Screen -->
    <div id="death-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-black/98 z-[120]">
        <h2 class="text-8xl md:text-9xl font-black text-red-700 mb-6 italic uppercase">ELIMINATED</h2>
        <button onclick="location.reload()" class="interactive bg-red-700 text-white font-black py-4 px-20 rounded-xl text-xl hover:bg-red-600 uppercase tracking-widest">
            RESPAWN
        </button>
    </div>

    <script>
        let scene, camera, renderer, clock, player;
        let entities = [], projectiles = [], particles = [];
        let gameActive = false, killCount = 0, selectedClassType = 'berserker';
        const keys = {};

        // PLAYER STATS
        const PLAYER_CONFIGS = {
            infantry: { hp: 200, speed: 0.18, damage: 45, color: 0x3b82f6, range: 3.0, cooldown: 20, hasShield: true, defense: 1.0 },
            knight: { hp: 300, speed: 0.14, damage: 120, color: 0x1d4ed8, range: 3.5, cooldown: 30, defense: 1.0 },
            crusader: { hp: 450, speed: 0.22, damage: 50, color: 0xf59e0b, range: 3.2, cooldown: 35, defense: 1.0 },
            berserker: { hp: 250, speed: 0.28, damage: 95, color: 0xdc2626, range: 2.8, cooldown: 15, defense: 0.25 },
            archer: { hp: 180, speed: 0.24, damage: 45, color: 0x10b981, range: 35, cooldown: 25, defense: 1.0 }
        };

        // BOT NERFS - All AI stats are scaled down for playability
        const AI_HP_SCALE = 0.5;      // AI has half health
        const AI_SPEED_SCALE = 0.6;   // AI is 40% slower than player
        const AI_DMG_SCALE = 0.35;    // AI deals 35% of player damage (No more 2-shots!)

        function selectClass(type) {
            selectedClassType = type;
            document.querySelectorAll('.class-btn').forEach(b => {
                b.classList.remove('border-red-600', 'scale-110');
                b.classList.add('border-slate-700');
            });
            document.getElementById(`btn-${type}`).classList.add('border-red-600', 'scale-110');
            document.getElementById(`btn-${type}`).classList.remove('border-slate-700');
        }

        function toggleControlsModal() {
            document.getElementById('controls-modal').classList.toggle('hidden');
        }

        function createCharacter(type, isPlayer) {
            const group = new THREE.Group();
            const baseStats = PLAYER_CONFIGS[type];

            // Apply nerfs to AI stats
            const stats = isPlayer ? baseStats : {
                ...baseStats,
                hp: baseStats.hp * AI_HP_SCALE,
                speed: baseStats.speed * AI_SPEED_SCALE,
                damage: baseStats.damage * AI_DMG_SCALE,
                cooldown: baseStats.cooldown * 1.5 // Bots attack slower too
            };

            // Body
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.5, 0.5), new THREE.MeshStandardMaterial({ color: stats.color }));
            body.position.y = 1; body.castShadow = true; group.add(body);

            // Head (Player is white, AI is dark)
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.5, 0.6), new THREE.MeshStandardMaterial({ color: isPlayer ? 0xffffff : 0x111111 }));
            head.position.y = 2.1; group.add(head);

            if (stats.hasShield) {
                const shield = new THREE.Mesh(new THREE.BoxGeometry(0.1, 1.2, 0.8), new THREE.MeshStandardMaterial({ color: 0x64748b }));
                shield.position.set(-0.6, 1.2, 0.2);
                group.add(shield);
                group.shieldRef = shield;
            }

            let weapon;
            if (type === 'archer') {
                weapon = new THREE.Mesh(new THREE.TorusGeometry(0.5, 0.05, 6, 12, Math.PI), new THREE.MeshStandardMaterial({ color: 0x1e293b }));
                weapon.rotation.y = Math.PI/2; weapon.position.set(0.6, 1.3, 0.3);
            } else {
                weapon = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.12, stats.range), new THREE.MeshStandardMaterial({ color: 0xf8fafc, metalness: 0.8 }));
                weapon.position.set(0.7, 1.2, stats.range/2);
            }
            group.add(weapon);

            return {
                mesh: group, weapon, type, isPlayer, 
                hp: stats.hp, maxHp: stats.hp,
                speed: stats.speed, damage: stats.damage, 
                range: stats.range, cooldown: 0, defense: stats.defense,
                isBlocking: false,
                attack(rot = null) {
                    if (this.cooldown > 0 || this.isBlocking) return;
                    if (rot !== null && this.type === 'archer') this.mesh.rotation.y = rot;
                    this.cooldown = stats.cooldown;
                    this.weapon.rotation.x -= 1.4;
                    setTimeout(() => { if(this.weapon) this.weapon.rotation.x += 1.4; }, 80);
                    if (this.type === 'archer') { spawnProjectile(this); } else {
                        const targets = [player, ...entities].filter(e => e && e !== this && e.hp > 0);
                        targets.forEach(t => {
                            if (this.mesh.position.distanceTo(t.mesh.position) < this.range + 0.8) t.takeDamage(this.damage, this);
                        });
                    }
                },
                takeDamage(amt, attacker) {
                    let d = amt * (this.isBlocking ? 0.1 : this.defense);
                    this.hp -= d; createBlood(this.mesh.position);
                    if (this.hp <= 0) {
                        if (attacker && attacker.isPlayer && !this.isPlayer) {
                            killCount++; document.getElementById('score').innerText = `KILLS: ${killCount}`;
                        }
                        if (this.isPlayer) die();
                    } else if (this.isPlayer) {
                        document.getElementById('hp-bar').style.width = (this.hp / this.maxHp * 100) + "%";
                    }
                }
            };
        }

        function spawnProjectile(owner) {
            const p = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.1, 1.5), new THREE.MeshStandardMaterial({ color: 0x000000 }));
            p.position.copy(owner.mesh.position).y = 1.3;
            p.rotation.copy(owner.mesh.rotation);
            const speed = owner.isPlayer ? 1.8 : 0.6; // AI arrows are slower now
            const vel = new THREE.Vector3(0, 0, speed).applyQuaternion(owner.mesh.quaternion);
            projectiles.push({ mesh: p, owner, life: 100, velocity: vel });
            scene.add(p);
        }

        function createBlood(pos) {
            const mat = new THREE.MeshStandardMaterial({ color: 0x991b1b });
            for(let i=0; i<3; i++) {
                const b = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 0.2), mat);
                b.position.copy(pos).y = 1.4;
                particles.push({ mesh: b, vel: new THREE.Vector3((Math.random()-0.5)*0.2, 0.2, (Math.random()-0.5)*0.2), life: 1 });
                scene.add(b);
            }
        }

        function die() { gameActive = false; document.getElementById('death-screen').style.display = 'flex'; }

        function spawnNPC() {
            const available = Object.keys(PLAYER_CONFIGS);
            const type = available[Math.floor(Math.random() * available.length)];
            const npc = createCharacter(type, false);
            const a = Math.random() * Math.PI * 2, d = 40 + Math.random() * 50;
            npc.mesh.position.set(Math.cos(a)*d, 0, Math.sin(a)*d);
            entities.push(npc); scene.add(npc.mesh);
        }

        function startGame() {
            document.getElementById('start-button').style.display = 'none';
            document.getElementById('loading-indicator').classList.remove('hidden');
            
            setTimeout(() => {
                try {
                    scene = new THREE.Scene();
                    scene.background = new THREE.Color(0x020617);
                    scene.fog = new THREE.Fog(0x020617, 30, 160);

                    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
                    renderer = new THREE.WebGLRenderer({ antialias: true });
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    renderer.shadowMap.enabled = true;
                    document.body.appendChild(renderer.domElement);

                    clock = new THREE.Clock();

                    scene.add(new THREE.AmbientLight(0xffffff, 0.5));
                    const sun = new THREE.DirectionalLight(0xffffff, 0.8);
                    sun.position.set(60, 120, 60);
                    sun.castShadow = true;
                    scene.add(sun);

                    const ground = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshStandardMaterial({ color: 0x111827 }));
                    ground.rotation.x = -Math.PI / 2; ground.receiveShadow = true; scene.add(ground);

                    player = createCharacter(selectedClassType, true);
                    scene.add(player.mesh);

                    for(let i=0; i<25; i++) spawnNPC();

                    window.addEventListener('keydown', e => {
                        keys[e.code] = true;
                        if (e.code === 'KeyT' && player.type === 'infantry') {
                            player.isBlocking = true;
                            document.getElementById('block-overlay').style.display = 'block';
                            if(player.mesh.shieldRef) {
                                player.mesh.shieldRef.position.set(0, 1.2, 0.6);
                                player.mesh.shieldRef.rotation.y = Math.PI/2;
                            }
                        }
                        if (player.type === 'archer') {
                            if (e.code === 'ArrowUp') player.attack(0);
                            if (e.code === 'ArrowDown') player.attack(Math.PI);
                            if (e.code === 'ArrowLeft') player.attack(Math.PI/2);
                            if (e.code === 'ArrowRight') player.attack(-Math.PI/2);
                        } else if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Space'].includes(e.code)) {
                            player.attack();
                        }
                    });

                    window.addEventListener('keyup', e => {
                        keys[e.code] = false;
                        if (e.code === 'KeyT' && player.type === 'infantry') {
                            player.isBlocking = false;
                            document.getElementById('block-overlay').style.display = 'none';
                            if(player.mesh.shieldRef) {
                                player.mesh.shieldRef.position.set(-0.6, 1.2, 0.2);
                                player.mesh.shieldRef.rotation.y = 0;
                            }
                        }
                    });

                    document.getElementById('start-screen').style.display = 'none';
                    gameActive = true;
                    animate();
                } catch (e) {
                    location.reload();
                }
            }, 150);
        }

        function animate() {
            if (!gameActive) return;
            requestAnimationFrame(animate);

            const curMove = new THREE.Vector3(0,0,0);
            if (!player.isBlocking) {
                if (keys['KeyW']) curMove.z += 1; if (keys['KeyS']) curMove.z -= 1;
                if (keys['KeyA']) curMove.x += 1; if (keys['KeyD']) curMove.x -= 1;
            }

            if (curMove.length() > 0) {
                curMove.normalize().multiplyScalar(player.speed);
                player.mesh.position.add(curMove);
                if (player.cooldown < 5 || player.type !== 'archer') player.mesh.lookAt(player.mesh.position.clone().add(curMove));
            }

            camera.position.lerp(new THREE.Vector3(player.mesh.position.x, player.mesh.position.y+20, player.mesh.position.z-26), 0.1);
            camera.lookAt(player.mesh.position);

            entities.forEach((ent, i) => {
                if (ent.cooldown > 0) ent.cooldown--;
                const others = [player, ...entities].filter(e => e && e !== ent && e.hp > 0);
                let near = null, dMin = Infinity;
                others.forEach(o => {
                    const d = ent.mesh.position.distanceTo(o.mesh.position);
                    if (d < dMin) { dMin = d; near = o; }
                });

                if (near) {
                    ent.mesh.lookAt(near.mesh.position);
                    if (dMin > ent.range * 0.85) {
                        const dir = new THREE.Vector3().subVectors(near.mesh.position, ent.mesh.position).normalize();
                        ent.mesh.position.add(dir.multiplyScalar(ent.speed));
                    } else { ent.attack(); }
                }

                if (ent.hp <= 0) { scene.remove(ent.mesh); entities.splice(i, 1); spawnNPC(); }
            });

            projectiles.forEach((p, i) => {
                p.mesh.position.add(p.velocity); p.life--;
                const ts = [player, ...entities].filter(e => e && e !== p.owner && e.hp > 0);
                ts.forEach(t => { 
                    if (p.mesh.position.distanceTo(t.mesh.position) < 1.6) { t.takeDamage(p.owner.damage, p.owner); p.life = 0; } 
                });
                if (p.life <= 0) { scene.remove(p.mesh); projectiles.splice(i, 1); }
            });

            particles.forEach((p, i) => {
                p.mesh.position.add(p.vel); p.vel.y -= 0.01; p.life -= 0.04;
                if (p.life <= 0) { scene.remove(p.mesh); particles.splice(i, 1); }
            });

            player.cooldown--;
            renderer.render(scene, camera);
        }

        window.onresize = () => {
            if(!camera) return;
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
